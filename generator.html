<!doctype html>
<title>Pixel L-System Generator</title>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.8.1/themes/prism.css" />
<style>
  img { image-rendering: pixelated; }
  code { outline: none; }
  pre { cursor: text; }
</style>

<div>
  <img id="image" />
  <img id="image-mini"/>
</div>

<pre>
  <code id="system-description" class="language-javascript" contenteditable>{
    width: 16,
    height: 16,
    init: [
      ['eyedrop', [0, 0, 0, 255]],
      ['moveTo', t => [Math.floor(t.width / 2), t.height - 1]],
      ['turnTo', [0, -1]],
    ],
    start: 'x',
    rules: {
      x: 'd',
      d: 't',
      t: 'tx',
    },
    actions: {
      'd': [['draw', 1]],
      'm': [['move', 1]],
      '>': [['turn', Math.PI / 6]],
      '<': [['turn', -Math.PI / 6]],
      '[': [['save']],
      ']': [['load']],
      't': [['draw', 2]],
    }
  }</code>
</pre>
<div id="error"></div>

<script type="text/javascript" src="https://cixzhang.github.io/Jot/jot.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.8.1/prism.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.8.1/components/prism-javascript.js"></script>
<script type="text/javascript" src="plant-texture.js"></script>

<script type="text/javascript">
  window.onload = () => {
    var image = document.getElementById('image');
    var mini = document.getElementById('image-mini');
    var description = document.getElementById('system-description');
    var actions_desc = document.getElementById('actions-description');
    var error = document.getElementById('error');
    var plantTex = new PlantTexture({ name: 'gen' });
    var task = new Jot.Task();

    function render() {
      try {
        var func = `(${description.innerText})`;
        task.run(func);
        var lsys = task.o()

        if (!lsys) return;

        plantTex.generate(lsys, { type: 'gen', count: 9, kinds: 1 });
        var pngSource = plantTex.toPNG();
        image.src = pngSource;
        image.onload = function () {
          image.width = image.naturalWidth * 5;
          image.height = image.naturalHeight * 5;
        };

        mini.src = pngSource;
        error.innerText = ''
      } catch(e) {
        console.log(e);
        error.innerText = `Invalid: ${e.message}`
      }
    }

    description.addEventListener('input', render);
    description.addEventListener('blur', () => Prism.highlightAll())
    render();
  }
</script>
