<!doctype html>
<title>Pixel L-System Generator</title>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.8.1/themes/prism.css" />
<style>
  img { image-rendering: pixelated; }
  code { outline: none; }
  pre { cursor: text; }
  #viewer {
    background-color: white;
    box-shadow: 1px 0px 8px rgba(0,0,0,0.1);
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    margin: auto;
    height: 400px;
    width: 400px;
  }

  .hide {
    display: none;
  }
</style>

<button id="debug">debug</button>

<div id="overview">
  <img id="image" />
  <img id="image-mini"/>
</div>

<div id="viewer" class="hide">
  <canvas id="viewer-canvas"></canvas>
  <button id="next-action">&gt;</button>
  <button id="next-view">&gt;&gt;</button>
</div>

<pre>
  <code id="system-description" class="language-javascript" contenteditable>{
    width: 16,
    height: 16,
    init: [
      ['eyedrop', [0, 0, 0, 255]],
      ['moveTo', t => [Math.floor(t.width / 2), t.height - 1]],
      ['turnTo', [0, -1]],
    ],
    start: 'x',
    rules: {
      x: 'd',
      d: 't',
      t: 'tx',
    },
    actions: {
      'd': [['draw', 1]],
      'm': [['move', 1]],
      '>': [['turn', Math.PI / 6]],
      '<': [['turn', -Math.PI / 6]],
      '[': [['save']],
      ']': [['load']],
      't': [['draw', 2]],
    }
  }</code>
</pre>
<div id="error"></div>

<script type="text/javascript" src="https://cixzhang.github.io/Jot/jot.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.8.1/prism.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.8.1/components/prism-javascript.js"></script>
<script type="text/javascript" src="plant-texture.js"></script>

<script type="text/javascript">
  window.onload = () => {
    var Turtle = PlantTexture.Turtle;
    var LSystem = PlantTexture.lSystem;

    var image = document.getElementById('image');
    var mini = document.getElementById('image-mini');
    var description = document.getElementById('system-description');
    var actions_desc = document.getElementById('actions-description');

    var viewer_canvas = document.getElementById('viewer-canvas');
    var next_action_button = document.getElementById('next-action');
    var next_view_button = document.getElementById('next-view');
    var debug_button = document.getElementById('debug');

    var error = document.getElementById('error');
    var plantTex = new PlantTexture({ name: 'gen' });
    var task = new Jot.Task();

    var viewer;
    var step;

    function render() {
      try {
        var func = `(${description.innerText})`;
        task.run(func);
        var lsys = task.o()

        if (!lsys) return;

        plantTex.generate(lsys, { type: 'gen', count: 9, kinds: 1 });
        var pngSource = plantTex.toPNG();
        image.src = pngSource;
        image.onload = function () {
          image.width = image.naturalWidth * 5;
          image.height = image.naturalHeight * 5;
        };

        mini.src = pngSource;

        viewer = initialize_viewer(lsys);

        error.innerText = '';
      } catch(e) {
        console.log(e);
        error.innerText = `Invalid: ${e.message}`;
      }
    }

    function* initialize_viewer(desc) {
      var i = 0;
      var count = 9;
      var lsystem = LSystem(desc.start, desc.rules);
      var turtle = new Turtle(desc.width, desc.height);

      var done = false;
      while (!done) {
        let state = lsystem.next();
        actions = PlantTexture.mapStateToActions(state.value, desc.actions);

        turtle.reset();
        turtle.perform(desc.init);

        done = state.done;
        yield render_step(turtle, actions);
      }
    }

    function* render_step(turtle, actions) {
      var iter = turtle.iterable(actions);
      var context = viewer_canvas.getContext('2d');
      var width = turtle.width * 8;
      var height = turtle.height * 8;

      viewer_canvas.width = width;
      viewer_canvas.height = height;

      while (!iter.next().done) {
        const imageData = new ImageData(turtle.pixels, turtle.width, turtle.height);
        context.clearRect(0, 0, width, height)
        context.putImageData(imageData, 0, 0, 0, 0, width, height);
        yield null;
      }
    }

    next_view_button.addEventListener('click', () => {
      if (!viewer || viewer.done) return;
      step = viewer.next().value;
    });

    next_action_button.addEventListener('click', () => {
      if (!step || step.done) return;
      step.next();
    });

    debug_button.addEventListener('click', () => {
      document.getElementById('viewer').classList.toggle('hide');
    });

    description.addEventListener('input', render);
    description.addEventListener('blur', () => Prism.highlightAll());
    render();
  }
</script>
